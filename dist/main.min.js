/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl)return;mw.libs.wphl={};const i="2.18.1",m="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){e=localStorage.getItem(e);if(!1===e)return!1;try{return JSON.parse(e)}catch(e){return null}},setObject(e,i){try{return localStorage.setItem(e,JSON.stringify(i))}catch(e){return!1}}},g=Object.fromEntries||(e=>{const i={};for(var[t,n]of e)i[t]=n;return i}),P=e=>"function"==typeof e.flat?e.flat():e.reduce((e,i)=>e.concat(i),[]),o=(e=i)=>e.split(".").map(e=>Number(e));const u=(e,...i)=>mw.msg("wphl-"+e,...i),n=(...e)=>$($.parseHTML(u(...e)));var e=(...i)=>()=>{var e=$("<p>",{html:u(...i)});return mw.notify(e,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),e},t=o().slice(0,2).join(".");const a="//fastly.jsdelivr.net",s="npm/codemirror@5.65.3",N="gh/bhsd-harry/codemirror-mediawiki@1.1.5",r="npm/wikiplus-highlight@"+t,{wgPageName:D,wgNamespaceNumber:U,wgPageContentModel:H,wgServerName:B,wgScriptPath:V,wgUserLanguage:F,skin:d}=mw.config.values,p=null!==mw.loader.getState("ext.CodeMirror"),l=m.getObject("InPageEditMwConfig")||{},Q=""+B+V,w=l[Q]||{},h=!(w.time>Date.now()-2592e6),q={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},c=p?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:s+"/mode/lua/lua.min.js",mediawiki:h?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:s+"/lib/codemirror.min.js",css:s+"/mode/css/css.min.js",javascript:s+"/mode/javascript/javascript.min.js",lua:s+"/mode/lua/lua.min.js",mediawiki:[],htmlmixed:s+"/mode/htmlmixed/htmlmixed.min.js",xml:s+"/mode/xml/xml.min.js"},f={searchcursor:s+"/addon/search/searchcursor.min.js",search:r+"/search.min.js",markSelection:s+"/addon/selection/mark-selection.min.js",activeLine:s+"/addon/selection/active-line.min.js",trailingspace:s+"/addon/edit/trailingspace.min.js",matchBrackets:s+"/addon/edit/matchbrackets.min.js",closeBrackets:s+"/addon/edit/closebrackets.min.js",matchTags:r+"/matchtags.min.js",fold:r+"/fold.min.js",wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title"},k=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!b.includes("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:["mediawiki","widget"]},{option:"fold",modes:["mediawiki","widget"]}];let b=m.getObject("Wikiplus-highlight-addons")||["search"],y=m.getObject("Wikiplus-highlight-indent")||4;const J={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},x=i=>e=>{e.replaceSelection(e.getSelection().split("\n").map(i).join("\n"),"around")},C=x(e=>e.split("").map(e=>{if(e in J)return`&${J[e]};`;const i=e.charCodeAt();return i<256?`&#${i};`:`&#x${i.toString(16)};`}).join("")),v=({keyMap:e})=>e.default===e.pcDefault,K={"Ctrl-/":C,"Ctrl-\\":x(encodeURIComponent)},R={"Cmd-/":C,"Cmd-\\":x(encodeURIComponent)},j=(p,e)=>{if(["mediawiki","widget"].includes(e)&&b.includes("contextmenu")){const i=$(p.getWrapperElement()).addClass("CodeMirror-contextmenu"),[t]=(mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]})["functionSynonyms"];e=i=>Object.keys(t).filter(e=>t[e]===i).map(e=>e.startsWith("#")?e:"#"+e);const w=e("invoke"),h=e("widget");i.contextmenu(({pageX:e,pageY:i})=>{const t=p.coordsChar({left:e,top:i}),{line:n,ch:o}=t,a=p.getTokenTypeAt(t);if(/\bmw-(?:template-name|parserfunction)\b/.test(a)){const c=p.getLineTokens(n);for(var[s,{type:r,end:d,string:l}]of[...c.entries()].reverse())0<s&&c[s-1].type===r&&(c[s-1].end=d,c[s-1].string+=l,c.splice(s,1));const m=c.findIndex(({start:e,end:i})=>e<o&&i>=o),u=c[m].string.replace(/\u200e/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(a)){const g=new mw.Title(u);return 0!==g.namespace||u.startsWith(":")?open(g.getUrl(),"_blank"):open(mw.util.getUrl("Template:"+u),"_blank"),!1}if(!(m<2)&&/\bmw-parserfunction-delimiter\b/.test(c[m-1].type)&&/\bmw-parserfunction-name\b/.test(c[m-2].type)){e=c[m-2].string.trim().toLowerCase();if(w.includes(e))open(mw.util.getUrl("Module:"+u),"_blank");else{if(!h.includes(e))return;open(mw.util.getUrl("Widget:"+u,{action:"edit"}),"_blank")}return!1}}})}};let S=m.getObject("Wikiplus-highlight-i18n"),M;S?((e,i)=>{var[e,t]=o(e),[i,n]=o(i);return e<i||e===i&&t<n})(S["wphl-version"],i)&&(M=e("welcome-new-addon",i,1)):(S={},M=e("welcome"));const W={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant"}[F]||"en",G=`${a}/${r}/i18n/${W}.json`,X=S["wphl-version"]===t;e=async()=>{X&&S["wphl-lang"]===W||(S=await $.ajax(G,{dataType:"json",cache:!0}),m.setObject("Wikiplus-highlight-i18n",S)),mw.messages.set(S)},t=Promise.all([mw.loader.using("mediawiki.util"),e()]);const O=e=>e.length?mw.loader.using(e):Promise.resolve(),E=e=>e.length?$.ajax(a+"/"+(1<e.length?"combine/":"")+e.join(),{dataType:"script",cache:!0}):Promise.resolve(),Y=async(e,i)=>{var t=e.filter(e=>!e.includes("/")),e=e.filter(e=>e.includes("/"));return!0===i?(await O(t),E(e)):!1===i?(await E(e),O(t)):Promise.all([O(t),E(e)])};let _;const z=(e,i=!1)=>{const t=[];for(var{option:n,addon:o=n,download:a=Array.isArray(o)?n:o,only:s}of k)s&&i||n in e.optionHandlers||!Z(o,b)||t.push(f[a]);return t},Z=(e,i)=>Array.isArray(e)?e.some(e=>i.includes(e)):i.includes(e),ee=e=>{let i=[];var t="function"==typeof window.CodeMirror,n=t?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{}};if(t||(i.push(c.lib),p||mw.loader.load(`${a}/${s}/lib/codemirror.min.css`,"text/css")),"mediawiki"===e&&w.config&&w.config.tags.html&&(e="html"),["mediawiki","widget"].includes(e)&&!n.modes.mediawiki&&(mw.loader.load(`${a}/${N}/mediawiki.min.css`,"text/css"),i.push(N+"/mediawiki.min.js")),["widget","html"].includes(e))for(const o of["css","javascript","mediawiki","htmlmixed","xml"])n.modes[o]||(i=i.concat(c[o]));else i=i.concat(c[e]);return n.prototype.getSearchCursor||!b.includes("search")||b.includes("wikiEditor")||i.push(f.searchcursor),n.commands.findForward||!b.includes("search")||b.includes("wikiEditor")||i.push(f.search),"ready"!==mw.loader.getState("ext.wikiEditor")&&b.includes("wikiEditor")&&i.push(f.wikiEditor),"ready"!==mw.loader.getState("mediawiki.Title")&&b.includes("contextmenu")&&i.push(f.contextmenu),i.push(...z(n)),Y(i,t?void 0:p)},ie=e=>{l[Q]={config:e,time:Date.now()},m.setObject("InPageEditMwConfig",l)},te=async(i,t)=>{if(["mediawiki","widget"].includes(i)){p&&h&&await t;let e=mw.config.get("extCodeMirrorConfig");if(e||h||!X||({config:e}=w,e.tags.ref&&(e.tagModes.ref="text/mediawiki"),mw.config.set("extCodeMirrorConfig",e)),e&&e.redirect&&e.img)return e;if(e)return e;const{magicwords:n,extensiontags:o,functionhooks:a,variables:s}=(await(new mw.Api).get({meta:"siteinfo",siprop:e?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}))["query"],r=["msg","raw","msgnw","subst","safesubst"];i=e=>P(e.map(({aliases:e,name:i})=>e.map(e=>({alias:e,name:i})))),t=e=>g(e.map(({alias:e,name:i})=>[e.replace(/:$/,""),i]));if(e){const[d]=e["functionSynonyms"];d.subst||i(n.filter(({name:e})=>r.includes(e))).forEach(({alias:e,name:i})=>{d[e.replace(/:$/,"")]=i})}else{e={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:g(o.map(e=>[e.slice(1,-1),!0])),urlProtocols:mw.config.get("wgUrlProtocols")};const l=new Set([...a,...s,...r]),c=n.filter(({name:e,aliases:i})=>i.some(e=>/^__.+__$/.test(e))||l.has(e)),m=i(c.filter(e=>e["case-sensitive"])),u=i(c.filter(e=>!e["case-sensitive"])).map(({alias:e,name:i})=>({alias:e.toLowerCase(),name:i}));e.doubleUnderscore=[t(u.filter(({alias:e})=>/^__.+__$/.test(e))),t(m.filter(({alias:e})=>/^__.+__$/.test(e)))],e.functionSynonyms=[t(u.filter(({alias:e})=>!/^__.+__|^#$/.test(e))),t(m.filter(({alias:e})=>!/^__.+__|^#$/.test(e)))]}return e.redirect=n.find(({name:e})=>"redirect"===e).aliases,e.img=t(i(n.filter(({name:e})=>e.startsWith("img_")))),mw.config.set("extCodeMirrorConfig",e),ie(e),e}},ne={getContents(){return _.getValue()},setContents(e){return _.setValue(e),this},getSelection(){return _.getSelection()},setSelection(e){return _.setSelection(_.posFromIndex(e.start),"end"in e?_.posFromIndex(e.end):void 0),_.focus(),this},replaceSelection(e){return _.replaceSelection(e),this},getCaretPosition(e){var i=_.indexFromPos(_.getCursor("from")),t=_.indexFromPos(_.getCursor("to"));return e.startAndEnd?[i,t]:i},scrollToCaretPosition(){return _.scrollIntoView(),this}},oe=async(e,i)=>{const o=i?"javascript":await(async()=>{if(![274,828].includes(U)||D.endsWith("/doc"))return D.endsWith("/doc")?"mediawiki":q[H];{const e=274===U?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(u("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()}})(),t=ee(o),[n]=await Promise.all([te(o,t),t]);if(!i&&b.includes("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const r=$.wikiEditor.modules.dialogs["config"];e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...r.getDefaultConfig()}),r.replaceIcons(e)}}catch(e){b.splice(b.indexOf("wikiEditor"),1),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===o&&n.tags.html?(n.tagModes.html="htmlmixed",await ee("html")):"widget"!==o||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});var a=e.height();_&&_.toTextArea();const s=i||"json"===H;if((_=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:o,mwConfig:n,json:s},g(k.map(({option:e,addon:i=e,modes:t,complex:n=e=>!t||t.includes(e)})=>{i=Array.isArray(i)?i[0]:i;return[e,b.includes(i)&&n(o,s)]})),"mediawiki"===o?{extraKeys:b.includes("escape")&&(v(CodeMirror)?K:R)}:{indentUnit:b.includes("indentWithSpace")?y:4,indentWithTabs:!b.includes("indentWithSpace")}))).setSize(null,a),_.refresh(),_.getWrapperElement().id="Wikiplus-CodeMirror",e.textSelection("register",ne),j(_,o),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!i){const d="object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){var i=m.getObject("Wikiplus_Settings");return i&&i[e]}},l=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},c=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};_.addKeyMap($.extend(v(CodeMirror)?{"Ctrl-S":l,"Shift-Ctrl-S":c}:{"Cmd-S":l,"Shift-Cmd-S":c},[!0,"true"].includes(d.getSetting("esc_to_exit_quickedit"))?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}mw.hook("wiki-codemirror").fire(_)},ae=new MutationObserver(e=>{const i=$(P(e.map(({addedNodes:e})=>[...e]))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");0!==i.length&&oe(i,"Wikiplus-Setting-Input"===i.attr("id"))}),se=(ae.observe(document.body,{childList:!0}),document.getElementById("wphl-style")||mw.loader.addStyleTag("#Wikiplus-CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both;-moz-user-select:auto;-webkit-user-select:auto;user-select:auto}#Wikiplus-CodeMirror .CodeMirror-gutter-wrapper{-moz-user-select:none;-webkit-user-select:none;user-select:none}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}")),{get:re=function(e){return e.value},set:de=function(e,i){e.value=i}}=(se.id="wphl-style",$.valHooks.textarea||{}),le=e=>["Wikiplus-Quickedit","Wikiplus-Setting-Input"].includes(e.id);$.valHooks.textarea={get(e){return le(e)&&_?_.getValue():re(e)},set(e,i){le(e)&&_?_.setValue(i):de(e,i)}},await t;let I,T,A,ce,L;const me=(e=b)=>{L.toggle(e.includes("indentWithSpace"))};const ue=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions"}[d]||"p-cactions","#",u("portlet"),"wphl-settings")).click(async e=>{if(e.preventDefault(),I)T.setValue(b),A.setValue(y);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),I=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const i=new OO.ui.WindowManager;i.$element.appendTo(document.body),i.addWindows([I]),T=new OO.ui.CheckboxMultiselectInputWidget({options:[...k.map(({option:e,addon:i=e})=>{const t=Array.isArray(i)?i[0]:i;return{data:t,label:n("addon-"+t.toLowerCase())}}),...["wikiEditor","escape","contextmenu","indentWithSpace","otherEditors"].map(e=>({data:e,label:n("addon-"+e.toLowerCase())}))],value:b}).on("change",me),A=new OO.ui.NumberInputWidget({min:0,value:y}),ce=new OO.ui.FieldLayout(T,{label:u("addon-label"),notices:[u("addon-notice")],align:"top"}),L=new OO.ui.FieldLayout(A,{label:u("addon-indent")}),me()}e="object"==typeof window.Wikiplus||"object"==typeof window.Pages;T.$element.find(".oo-ui-checkboxInputWidget").first().toggleClass("oo-ui-widget-enabled",e).children("input").prop("disabled",!e),I.open({title:u("addon-title"),message:ce.$element.add(L.$element).add($("<p>",{html:u("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===W||"minerva"===d?"medium":"small"}).closing.then(e=>{ce.$element.detach(),L.$element.detach(),"object"==typeof e&&"accept"===e.action&&(b=T.getValue(),y=Number(A.getValue()),m.setObject("Wikiplus-highlight-addons",b),m.setObject("Wikiplus-highlight-indent",y))})}),ge=("minerva"===d&&ue.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof M&&M().find("#wphl-settings-notify").click(e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}),async i=>{if(b.includes("otherEditors")){let e=i.getOption("mode");e="text/mediawiki"===e?"mediawiki":e;var t=z(CodeMirror,!0),n=i.getOption("json");await Y(t);for(const{option:a,addon:s=a,modes:r,complex:d=e=>!r||r.includes(e)}of k.filter(({only:e})=>!e)){var o=Array.isArray(s)?s[0]:s;void 0===i.getOption(a)&&b.includes(o)&&i.setOption(a,d(e,n))}"mediawiki"!==e&&b.includes("indentWithSpace")?(i.setOption("indentUnit",y),i.setOption("indentWithTabs",!1)):"mediawiki"===e&&b.includes("escape")&&i.addKeyMap(v(CodeMirror)?K:R,!0),j(i,e)}});mw.hook("InPageEdit.quickEdit.codemirror").add(({cm:e})=>ge(e)),mw.hook("inspector").add(e=>ge(e)),mw.libs.wphl={version:i,options:k,addons:b,i18n:S,i18nLang:W,wphlStyle:se,$portlet:ue,USING_LOCAL:p,MODE_LIST:c,ADDON_LIST:f,msg:u,htmlMsg:n,escapeHTML:C,handleContextMenu:j,setI18N:e,getAddonScript:z,intersect:Z,updateCachedConfig:ie,getMwConfig:te,renderEditor:oe,handleOtherEditors:ge}})();
//# sourceMappingURL=main.min.js.map