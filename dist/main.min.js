/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";var e="2.12.1";const t="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){e=localStorage.getItem(e);if(!1===e)return!1;try{return JSON.parse(e)}catch(e){return null}},setObject(e,i){var t;try{return t=JSON.stringify(i),localStorage.setItem(e,t)}catch(e){return!1}}},u=Object.fromEntries||(e=>{const i={};for(var[t,a]of e)i[t]=a;return i}),p=Array.prototype.flat||function(){return this.reduce((e,i)=>e.concat(i),[])},n=e=>e.split(".").map(e=>Number(e));const r=(e,...i)=>mw.msg("wphl-"+e,...i);var i=(...i)=>()=>{var e=$("<p>",{html:r(...i)});return mw.notify(e,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),e},a=n(e).slice(0,2).join(".");const s="//fastly.jsdelivr.net",d="npm/codemirror@5.65.3",l="gh/bhsd-harry/codemirror-mediawiki@1.1.5",o="npm/wikiplus-highlight@"+a,{wgPageName:c,wgNamespaceNumber:m,wgPageContentModel:g,wgServerName:P,wgScriptPath:B,wgUserLanguage:N,skin:h}=mw.config.values,w=null!==mw.loader.getState("ext.CodeMirror"),k=t.getObject("InPageEditMwConfig")||{},f=""+P+B,b=k[f]||{},y=b.time<Date.now()-2592e6,H={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},x=w?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:d+"/mode/lua/lua.min.js",mediawiki:y?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:d+"/lib/codemirror.min.js",css:d+"/mode/css/css.min.js",javascript:d+"/mode/javascript/javascript.min.js",lua:d+"/mode/lua/lua.min.js",mediawiki:[],htmlmixed:d+"/mode/htmlmixed/htmlmixed.min.js",xml:d+"/mode/xml/xml.min.js"},v={searchcursor:d+"/addon/search/searchcursor.min.js",search:o+"/search.min.js",activeLine:d+"/addon/selection/active-line.min.js",markSelection:d+"/addon/selection/mark-selection.min.js",trailingspace:d+"/addon/edit/trailingspace.min.js",matchBrackets:d+"/addon/edit/matchbrackets.min.js",matchTags:o+"/matchtags.min.js",fold:o+"/fold.min.js"};let j=t.getObject("Wikiplus-highlight-addons")||["search"],W=t.getObject("Wikiplus-highlight-indent")||"4";const U=async(c,e)=>{if(["mediawiki","widget"].includes(e)&&j.includes("contextmenu")){const i=$(c.getWrapperElement()).addClass("CodeMirror-contextmenu"),[t]=(mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]})["functionSynonyms"];e=i=>Object.keys(t).filter(e=>t[e]===i).map(e=>e.startsWith("#")?e:"#"+e);const m=e("invoke"),g=e("widget");await mw.loader.using("mediawiki.Title"),i.contextmenu(({pageX:e,pageY:i})=>{const t=c.coordsChar({left:e,top:i}),{line:a,ch:n}=t,o=c.getTokenTypeAt(t);if(/\bmw-(?:template-name|parserfunction)\b/.test(o)){const s=c.getLineTokens(a),r=s.findIndex(({start:e,end:i})=>e<n&&i>=n),d=s[r].string.replace(/\u200e/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(o)){const l=new mw.Title(d);return 0!==l.namespace||d.startsWith(":")?open(l.getUrl(),"_blank"):open(mw.util.getUrl("Template:"+d),"_blank"),!1}if(!(r<2)&&/\bmw-parserfunction-delimiter\b/.test(s[r-1].type)&&/\bmw-parserfunction-name\b/.test(s[r-2].type)){e=s[r-2].string.trim().toLocaleLowerCase();if(m.includes(e))open(mw.util.getUrl("Module:"+d),"_blank");else{if(!g.includes(e))return;open(mw.util.getUrl("Widget:"+d,{action:"edit"}),"_blank")}return!1}}})}};let C=t.getObject("Wikiplus-highlight-i18n"),M;C?((e,i)=>{var[e,t]=n(e),[i,a]=n(i);return e<i||e===i&&t<a})(C["wphl-version"],e)&&(M=i("welcome-new-addon",e,1)):(C={},M=i("welcome"));const S={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant"}[N]||"en",Q=`${s}/${o}/i18n/${S}.json`,D=C["wphl-version"]===a;e=Promise.all([mw.loader.using("mediawiki.util"),(async()=>{D&&C["wphl-lang"]===S||(C=await $.ajax(Q,{dataType:"json",cache:!0}),t.setObject("Wikiplus-highlight-i18n",C)),mw.messages.set(C)})()]);const O=(e,i)=>0===e.length?Promise.resolve():i?mw.loader.using(e):$.ajax(s+"/"+(1<e.length?"combine/":"")+e.join(),{dataType:"script",cache:!0});let _;const z=[{option:"styleActiveLine",addon:"activeLine"},{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:!0},{option:"matchTags",addon:["matchTags","fold"],modes:["mediawiki","widget"]},{option:"fold",modes:["mediawiki","widget"]}],V=(e,i=!1)=>{const t=[];for(var{option:a,addon:n=a,download:o=Array.isArray(n)?a:n,only:s}of z)s&&i||e.optionHandlers[a]||!q(n,j)||t.push(v[o]);return t},q=(e,i)=>Array.isArray(e)?e.some(e=>i.includes(e)):i.includes(e),F=async e=>{let i=[];const t=[],a=[],n="function"==typeof window.CodeMirror,o=n?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{}};["mediawiki","widget"].includes(e)&&!o.modes.mediawiki&&(mw.loader.load(`${s}/${l}/mediawiki.min.css`,"text/css"),(w?t:i).push(l+"/mediawiki.min.js")),"mediawiki"===e&&b.config&&b.config.tags.html&&(e="html"),n||((w?i:a).push(x.lib),w||mw.loader.load(`${s}/${d}/lib/codemirror.min.css`,"text/css")),!o.prototype.getSearchCursor&&j.includes("search")&&a.push(v.searchcursor),!o.commands.findForward&&j.includes("search")&&a.push(v.search),a.push(...V(o)),["widget","html"].includes(e)?["css","javascript","mediawiki","htmlmixed","xml"].forEach(e=>{o.modes[e]||(i=i.concat(x[e]))}):o.modes[e]||("lua"===e?(w?t:i).push(x.lua):i=i.concat(x[e])),n?await Promise.all([O(i,w),O(t),O(a)]):w?(await O(i,!0),await Promise.all([O(t),O(a)])):(await O(a),await O(i))},J=e=>{k[f]={config:e,time:Date.now()},t.setObject("InPageEditMwConfig",k)},R=async(e,i)=>{const a=i?"javascript":await(async()=>{if(![274,828].includes(m)||c.endsWith("/doc"))return c.endsWith("/doc")?"mediawiki":H[g];{const e=274===m?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(r("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()}})();var t=F(a);const[n]=await Promise.all([(async(i,t)=>{if(["mediawiki","widget"].includes(i)){w&&y&&await t;let e=mw.config.get("extCodeMirrorConfig");if(e||y||!D||({config:e}=b,e.tags.ref&&(e.tagModes.ref="text/mediawiki"),mw.config.set("extCodeMirrorConfig",e)),e&&e.redirect&&e.img)return e;if(e)return e;const{magicwords:a,extensiontags:n,functionhooks:o,variables:s}=(await(new mw.Api).get({meta:"siteinfo",siprop:e?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}))["query"],r=["msg","raw","msgnw","subst","safesubst"];i=e=>p.call(e.map(({aliases:e,name:i})=>e.map(e=>({alias:e,name:i})))),t=e=>u(e.map(({alias:e,name:i})=>[e.replace(/:$/,""),i]));if(e){const[d]=e["functionSynonyms"];d.subst||i(a.filter(({name:e})=>r.includes(e))).forEach(({alias:e,name:i})=>{d[e.replace(/:$/,"")]=i})}else{e={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:u(n.map(e=>[e.slice(1,-1),!0])),urlProtocols:mw.config.get("wgUrlProtocols")};const l=new Set([...o,...s,...r]),c=a.filter(({name:e,aliases:i})=>i.some(e=>/^__.+__$/.test(e))||l.has(e)),m=i(c.filter(e=>e["case-sensitive"])),g=i(c.filter(e=>!e["case-sensitive"])).map(({alias:e,name:i})=>({alias:e.toLowerCase(),name:i}));e.doubleUnderscore=[t(g.filter(({alias:e})=>/^__.+__$/.test(e))),t(m.filter(({alias:e})=>/^__.+__$/.test(e)))],e.functionSynonyms=[t(g.filter(({alias:e})=>!/^__.+__|^#$/.test(e))),t(m.filter(({alias:e})=>!/^__.+__|^#$/.test(e)))]}return e.redirect=a.find(({name:e})=>"redirect"===e).aliases,e.img=t(i(a.filter(({name:e})=>e.startsWith("img_")))),mw.config.set("extCodeMirrorConfig",e),J(e),e}})(a,t),t]);"mediawiki"===a&&n.tags.html?(n.tagModes.html="htmlmixed",await F("html")):"widget"!==a||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});var t=e.height(),o=(_&&_.toTextArea(),i||"json"===g),s=$.client.profile()["name"];(_=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"safari"===s?"textarea":"contenteditable",lineNumbers:!0,lineWrapping:!0,mode:a,mwConfig:n,json:o},u(z.filter(({complex:e})=>!e).map(({option:e,addon:i=e,modes:t})=>{i=Array.isArray(i)?i[0]:i;return[e,j.includes(i)&&(!t||t.includes(a))]})),{matchBrackets:j.includes("matchBrackets")&&("mediawiki"!==a&&!o||{bracketRegex:/[{}[\]]/})},"mediawiki"===a?{}:{indentUnit:j.includes("indentWithSpace")?W:"4",indentWithTabs:!j.includes("indentWithSpace")}))).setSize(null,t),_.refresh(),U(_,a),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),i||(e=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},s=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},_.addKeyMap($.extend({"Ctrl-S":e,"Cmd-S":e,"Shift-Ctrl-S":s,"Shift-Cmd-S":s},Wikiplus.getSetting("esc_to_exit_quickedit")?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))),mw.hook("wiki-codemirror").fire(_)},K=new MutationObserver(e=>{const i=$(p.call(e.map(({addedNodes:e})=>[...e]))).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");0!==i.length&&R(i,"Wikiplus-Setting-Input"===i.attr("id"))}),X=(K.observe(document.body,{childList:!0}),document.getElementById("wphl-style")||mw.loader.addStyleTag("#Wikiplus-Quickedit+.CodeMirror,#Wikiplus-Setting-Input+.CodeMirror{border:1px solid #c8ccd1;line-height:1.3;clear:both}div.Wikiplus-InterBox{font-size:14px;z-index:100}.skin-minerva .Wikiplus-InterBox{font-size:16px}.cm-trailingspace{text-decoration:underline wavy red}div.CodeMirror span.CodeMirror-matchingbracket{box-shadow:0 0 0 2px #9aef98}div.CodeMirror span.CodeMirror-nonmatchingbracket{box-shadow:0 0 0 2px #eace64}#Wikiplus-highlight-dialog .oo-ui-messageDialog-title{margin-bottom:0.28571429em}#Wikiplus-highlight-dialog .oo-ui-flaggedElement-notice{font-weight:normal;margin:0}.CodeMirror-contextmenu .cm-mw-template-name{cursor:pointer}")),{get:Y=function(e){return e.value},set:G=function(e,i){e.value=i}}=(X.id="wphl-style",$.valHooks.textarea||{}),Z=e=>["Wikiplus-Quickedit","Wikiplus-Setting-Input"].includes(e.id);$.valHooks.textarea={get(e){return Z(e)&&_?_.getValue():Y(e)},set(e,i){Z(e)&&_?_.setValue(i):G(e,i)}},await e;let T,I,E,L,A;const ee=(e=j)=>{A.toggle(e.includes("indentWithSpace"))};const ie=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions"}[h]||"p-cactions","#",r("portlet"),"wphl-settings")).click(async e=>{if(e.preventDefault(),!T){await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),T=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const i=new OO.ui.WindowManager;i.$element.appendTo(document.body),i.addWindows([T]),I=new OO.ui.CheckboxMultiselectInputWidget({options:[{data:"search",label:r("addon-search")},{data:"activeLine",label:r("addon-active-line")},{data:"trailingspace",label:r("addon-trailingspace")},{data:"matchBrackets",label:r("addon-matchbrackets")},{data:"matchTags",label:r("addon-matchtags")},{data:"fold",label:r("addon-fold")},{data:"contextmenu",label:r("addon-contextmenu")},{data:"indentWithSpace",label:r("addon-indentwithspace")},{data:"otherEditors",label:r("2.12"===r("version")?"addon-othereditos":"addon-othereditors")}],value:j}).on("change",ee),E=new OO.ui.NumberInputWidget({min:0,value:W}),L=new OO.ui.FieldLayout(I,{label:r("addon-label"),notices:[r("addon-notice")],align:"top"}),A=new OO.ui.FieldLayout(E,{label:r("addon-indent")}),ee()}e="object"==typeof window.Wikiplus;I.$element.find(".oo-ui-checkboxInputWidget").first().toggleClass("oo-ui-widget-enabled",e).children("input").prop("disabled",!e),T.open({title:r("addon-title"),message:L.$element.add(A.$element).add($("<p>",{html:r("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===S?"medium":"small"}).closing.then(e=>{L.$element.detach(),A.$element.detach(),"object"==typeof e&&"accept"===e.action&&(j=I.getValue(),W=E.getValue(),t.setObject("Wikiplus-highlight-addons",j),t.setObject("Wikiplus-highlight-indent",W))})}),te=("minerva"===h&&ie.find("a").addClass("mw-ui-icon-minerva-settings"),"function"==typeof M&&M().find("#wphl-settings-notify").click(e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}),async i=>{if(j.includes("otherEditors")){let e=i.getOption("mode");e="text/mediawiki"===e?"mediawiki":e;var t,a,n,o=V(CodeMirror,!0);await O(o);for({option:t,addon:a=t,modes:n}of z.filter(({only:e,complex:i})=>!(e||i))){var s=Array.isArray(a)?a[0]:a;void 0!==i.getOption(t)||!j.includes(s)||n&&!n.includes(e)||i.setOption(t,!0)}void 0===i.getOption("matchBrackets")&&j.includes("matchBrackets")&&i.setOption("matchBrackets","mediawiki"!==e&&!i.getOption("json")||{bracketRegex:/[{}[\]]/}),"mediawiki"!==e&&j.includes("indentWithSpace")&&(i.setOption("indentUnit",W),i.setOption("indentWithTabs",!1)),U(i,e)}});mw.hook("InPageEdit.quickEdit.codemirror").add(({cm:e})=>te(e)),mw.hook("inspector").add(e=>te(e))})();
//# sourceMappingURL=main.min.js.map