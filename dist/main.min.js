/**
 * @name Wikiplus-highlight Wikiplus编辑器的CodeMirror语法高亮扩展
 * @author Bhsd <https://github.com/bhsd-harry>
 * @author 机智的小鱼君 <https://github.com/Dragon-Fish>
 * @license GPL-3.0
 */
(async()=>{"use strict";if(mw.libs.wphl&&mw.libs.wphl.version)return;mw.libs.wphl=mw.libs.wphl||{};const i="2.53",g="object"==typeof mw.storage&&"function"==typeof mw.storage.getObject?mw.storage:{getObject(e){var i=localStorage.getItem(e);if(!1===i)return!1;try{return JSON.parse(i)}catch(e){return null}},setObject(e,i){try{return localStorage.setItem(e,JSON.stringify(i))}catch(e){return!1}}},s=(Object.fromEntries=Object.fromEntries||(e=>{const i={};for(var[t,a]of e)i[t]=a;return i}),(e=i)=>e.split(".").map(Number));const w=(e,...i)=>mw.msg("wphl-"+e,...i),o=(...e)=>$($.parseHTML(w(...e)));var e=(...i)=>()=>{var e=$("<p>",{html:w(...i)});return mw.notify(e,{type:"success",autoHideSeconds:"long",tag:"wikiplus-highlight"}),e},t=s().slice(0,2).join(".");const p="//fastly.jsdelivr.net",h="npm/codemirror@5.65.3",L="gh/bhsd-harry/codemirror-mediawiki@1.1.6",D="npm/wikiparser-node@0.9.1-b",a="npm/wikiplus-highlight@"+t,{wgPageName:N,wgNamespaceNumber:u,wgPageContentModel:H,wgServerName:U,wgScriptPath:F,wgUserLanguage:V,skin:r}=mw["config"]["values"],k=null!==mw.loader.getState("ext.CodeMirror"),n=g.getObject("InPageEditMwConfig")||{},Q=""+U+F,f=n[Q]||{},b=!(f.time>Date.now()-2592e6),B={css:"css","sanitized-css":"css",javascript:"javascript",json:"javascript",wikitext:"mediawiki"},l=k?{lib:"ext.CodeMirror.lib",css:"ext.CodeMirror.lib.mode.css",javascript:"ext.CodeMirror.lib.mode.javascript",lua:h+"/mode/lua/lua.min.js",mediawiki:b?"ext.CodeMirror.data":[],htmlmixed:"ext.CodeMirror.lib.mode.htmlmixed",xml:[]}:{lib:h+"/lib/codemirror.min.js",css:h+"/mode/css/css.min.js",javascript:h+"/mode/javascript/javascript.min.js",lua:h+"/mode/lua/lua.min.js",mediawiki:[],htmlmixed:h+"/mode/htmlmixed/htmlmixed.min.js",xml:h+"/mode/xml/xml.min.js"},x={searchcursor:h+"/addon/search/searchcursor.min.js",search:a+"/search.min.js",markSelection:h+"/addon/selection/mark-selection.min.js",activeLine:h+"/addon/selection/active-line.min.js",trailingspace:h+"/addon/edit/trailingspace.min.js",matchBrackets:h+"/addon/edit/matchbrackets.min.js",closeBrackets:h+"/addon/edit/closebrackets.min.js",matchTags:a+"/matchtags.min.js",fold:a+"/fold.min.js",wikiEditor:"ext.wikiEditor",contextmenu:"mediawiki.Title",lint:h+"/addon/lint/lint.min.js",annotateScrollbar:h+"/addon/scroll/annotatescrollbar.min.js",parser:D+"/extensions/editor.min.js",lintWikitext:a+"/lint.min.js"},y=[{option:"styleSelectedText",addon:"search",download:"markSelection",only:!0,complex:()=>!j.has("wikiEditor")},{option:"styleActiveLine",addon:"activeLine"},{option:"showTrailingSpace",addon:"trailingspace"},{option:"matchBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||{bracketRegex:/[{}[\]]/}},{option:"autoCloseBrackets",addon:"closeBrackets",complex:(e,i)=>"mediawiki"!==e&&!i||'()[]{}""'},{option:"matchTags",addon:["matchTags","fold"],modes:new Set(["mediawiki","widget"])},{option:"fold",modes:new Set(["mediawiki","widget"])}],j=new Set(g.getObject("Wikiplus-highlight-addons")||["search"]);let v=g.getObject("Wikiplus-highlight-indent")||4;const R={'"':"quot","'":"apos","<":"lt",">":"gt","&":"amp"," ":"nbsp"},d=i=>e=>{e.replaceSelections(e.getSelections().map(e=>e.split("\n").map(i).join("\n")),"around")},q=d(e=>[...e].map(e=>{if(e in R)return`&${R[e]};`;const i=e.codePointAt();return i<256?`&#${i};`:`&#x${i.toString(16)};`}).join("")),K=d(e=>{if(e.includes("%"))try{return decodeURIComponent(e)}catch(e){}return encodeURIComponent(e)}),J=d(i=>{try{return decodeURIComponent(i.replace(/\.([\da-f]{2})/gi,"%$1"))}catch(e){return i}}),S=({keyMap:e})=>e.default===e.pcDefault,G=e=>{var i=S(e)?"Ctrl":"Cmd";return{[i+"-/"]:q,[i+"-\\"]:K,[`Shift-${i}-\\`]:J}},C=(w,e)=>{if(("mediawiki"===e||"widget"===e)&&j.has("contextmenu")){const t=$(w.getWrapperElement()).addClass("CodeMirror-contextmenu"),[a]=(mw.config.get("extCodeMirrorConfig")||{functionSynonyms:[{invoke:"invoke","调用":"invoke",widget:"widget","小工具":"widget"}]})["functionSynonyms"];var i=i=>new Set(Object.keys(a).filter(e=>a[e]===i).map(e=>e.startsWith("#")?e:"#"+e));const h=i("invoke"),u=i("widget");t.contextmenu(({pageX:e,pageY:i})=>{const t=w.coordsChar({left:e,top:i}),{line:a,ch:n}=t,o=w.getTokenTypeAt(t);if(/\bmw-(?:template-name|parserfunction)\b/.test(o)){const c=w.getLineTokens(a);for(let e=c.length-1;0<e;e--){var{type:s,end:r,string:l}=c[e];c[e-1].type===s&&(c[e-1].end=r,c[e-1].string+=l,c.splice(e,1))}const m=c.findIndex(({start:e,end:i})=>e<n&&i>=n),p=c[m].string.replace(/\u200E/g,"").replace(/_/g," ").trim();if(/\bmw-template-name\b/.test(o)){const g=new mw.Title(p);return 0!==g.namespace||p.startsWith(":")?open(g.getUrl(),"_blank"):open(mw.util.getUrl("Template:"+p),"_blank"),!1}if(!(m<2)&&/\bmw-parserfunction-delimiter\b/.test(c[m-1].type)&&/\bmw-parserfunction-name\b/.test(c[m-2].type)){var d=c[m-2].string.trim().toLowerCase();if(h.has(d))open(mw.util.getUrl("Module:"+p),"_blank");else{if(!u.has(d))return;open(mw.util.getUrl("Widget:"+p,{action:"edit"}),"_blank")}return!1}}})}},c=g.getObject("Wikiplus-highlight-i18n")||{};let m;c["wphl-version"]?((e,i)=>{var[t,a]=s(e),[n,o]=s(i);return t<n||t===n&&a<o})(c["wphl-version"],i)&&(m=e("welcome-upgrade",i,0)):m=e("welcome");const W={zh:"zh-hans","zh-hans":"zh-hans","zh-cn":"zh-hans","zh-my":"zh-hans","zh-sg":"zh-hans","zh-hant":"zh-hant","zh-tw":"zh-hant","zh-hk":"zh-hant","zh-mo":"zh-hant",ka:"ka"}[V]||"en",X=`${p}/${a}/i18n/${W}.json`,Y=c["wphl-version"]===t;e=async()=>{Y&&c["wphl-lang"]===W||(Object.assign(c,await $.ajax(X,{dataType:"json",cache:!0})),g.setObject("Wikiplus-highlight-i18n",c)),mw.messages.set(c)},t=Promise.all([mw.loader.using("mediawiki.util"),e()]);const M=e=>0<e.length?mw.loader.using(e):Promise.resolve(),Z=e=>0<e.length?$.ajax(p+"/"+(1<e.length?"combine/":"")+e.join(),{dataType:"script",cache:!0}):Promise.resolve(),ee=async(e,i)=>{var t=e.filter(e=>!e.includes("/")),a=e.filter(e=>e.includes("/"));return!0===i?(await M(t),Z(a)):!1===i?(await Z(a),M(t)):Promise.all([M(t),Z(a)])};let O;const ie=(e,i=!1)=>{const t=[];for(var{option:a,addon:n=a,download:o=Array.isArray(n)?a:n,only:s}of y)s&&i||a in e.optionHandlers||!te(n,j)||t.push(x[o]);return t},te=(e,i)=>Array.isArray(e)?e.some(e=>i.has(e)):i.has(e),ae=e=>{let i=[];var t,a="function"==typeof window.CodeMirror,n=a?window.CodeMirror:{modes:{},prototype:{},commands:{},optionHandlers:{},helpers:{}};if(a||(i.push(l.lib),k||mw.loader.load(`${p}/${h}/lib/codemirror.min.css`,"text/css")),"mediawiki"!==(e="mediawiki"===e&&f.config&&f.config.tags.html?"html":e)&&"widget"!==e||n.modes.mediawiki||(mw.loader.load(`${p}/${L}/mediawiki.min.css`,"text/css"),i.push(L+"/mediawiki.min.js")),"widget"===e||"html"===e)for(const o of["css","javascript","mediawiki","htmlmixed","xml"])n.modes[o]||(i=i.concat(l[o]));else i=i.concat(l[e]);return n.prototype.getSearchCursor||!j.has("search")||j.has("wikiEditor")||i.push(x.searchcursor),!n.prototype.annotateScrollbar&&"mediawiki"===e&&j.has("lint")&&i.push(x.annotateScrollbar),n.commands.find||!j.has("search")||j.has("wikiEditor")||i.push(x.search),!window.wikiparse&&"mediawiki"===e&&j.has("lint")&&i.push(x.parser),!n.optionHandlers.lint&&"mediawiki"===e&&j.has("lint")&&(mw.loader.load(`${p}/${h}/addon/lint/lint.min.css`,"text/css"),i.push(x.lint)),n.helpers.lint&&n.helpers.lint.mediawiki||"mediawiki"!==e||!j.has("lint")||i.push(x.lintWikitext),j.has("wikiEditor")&&((t=mw.loader.getState("ext.wikiEditor"))?"ready"!==t&&i.push(x.wikiEditor):j.delete("wikiEditor")),"ready"!==mw.loader.getState("mediawiki.Title")&&j.has("contextmenu")&&i.push(x.contextmenu),i.push(...ie(n)),ee(i,a?void 0:k)},ne=e=>{n[Q]={config:e,time:Date.now()},g.setObject("InPageEditMwConfig",n)},E=e=>e.flatMap(({aliases:e,name:i})=>e.map(e=>({alias:e,name:i}))),_=e=>Object.fromEntries(e.map(({alias:e,name:i})=>[e.replace(/:$/,""),i])),oe=e=>{for(const i of["indicator","poem","ref","tabs","tab","poll"])e.tags[i]&&(e.tagModes[i]="text/mediawiki")},se=async(e,i)=>{if("mediawiki"===e||"widget"===e){k&&b&&await i;let e=mw.config.get("extCodeMirrorConfig");if(e||b||!Y||({config:e}=f,oe(e),mw.config.set("extCodeMirrorConfig",e)),e&&e.redirect&&e.img)return e;const{magicwords:n,extensiontags:o,functionhooks:s,variables:r}=(await(new mw.Api).get({meta:"siteinfo",siprop:e?"magicwords":"magicwords|extensiontags|functionhooks|variables",formatversion:2}))["query"],l=new Set(["msg","raw","msgnw","subst","safesubst"]);if(e){const[d]=e["functionSynonyms"];var t,a;if(!d.subst)for({alias:t,name:a}of E(n.filter(({name:e})=>l.has(e))))d[t.replace(/:$/,"")]=a}else{e={tagModes:{pre:"mw-tag-pre",nowiki:"mw-tag-nowiki",ref:"text/mediawiki"},tags:Object.fromEntries(o.map(e=>[e.slice(1,-1),!0])),urlProtocols:mw.config.get("wgUrlProtocols")};const c=new Set([...s,...r,...l]),m=n.filter(({name:e,aliases:i})=>i.some(e=>/^__.+__$/.test(e))||c.has(e)),p=E(m.filter(e=>e["case-sensitive"])),g=E(m.filter(e=>!e["case-sensitive"])).map(({alias:e,name:i})=>({alias:e.toLowerCase(),name:i}));e.doubleUnderscore=[_(g.filter(({alias:e})=>/^__.+__$/.test(e))),_(p.filter(({alias:e})=>/^__.+__$/.test(e)))],e.functionSynonyms=[_(g.filter(({alias:e})=>!/^__.+__|^#$/.test(e))),_(p.filter(({alias:e})=>!/^__.+__|^#$/.test(e)))]}return e.redirect=n.find(({name:e})=>"redirect"===e).aliases,e.img=_(E(n.filter(({name:e})=>e.startsWith("img_")))),oe(e),mw.config.set("extCodeMirrorConfig",e),ne(e),e}},re={getContents(){return O.getValue()},setContents(e){return O.setValue(e),this},getSelection(){return O.getSelection()},setSelection(e){return O.setSelection(O.posFromIndex(e.start),"end"in e?O.posFromIndex(e.end):void 0),O.focus(),this},replaceSelection(e){return O.replaceSelection(e),this},getCaretPosition(e){var i=O.indexFromPos(O.getCursor("from")),t=O.indexFromPos(O.getCursor("to"));return e.startAndEnd?[i,t]:i},scrollToCaretPosition(){return O.scrollIntoView(),this}},le=async(e,i)=>{const o=i?"javascript":await(async()=>{if(N.endsWith("/doc"))return"mediawiki";if(274!==u&&828!==u)return B[H];const e=274===u?"Widget":"Lua";return await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),await OO.ui.confirm(w("contentmodel"),{actions:[{label:e},{label:"Wikitext",action:"accept"}]})?"mediawiki":e.toLowerCase()})(),t=ae(o),[a]=await Promise.all([se(o,t),t]);if(!i&&j.has("wikiEditor"))try{if("function"==typeof mw.addWikiEditor)mw.addWikiEditor(e);else{const{dialogs:{config:r}}=$["wikiEditor"]["modules"];e.wikiEditor("addModule",{...$.wikiEditor.modules.toolbar.config.getDefaultConfig(),...r.getDefaultConfig()}),r.replaceIcons(e)}}catch(e){j.delete("wikiEditor"),mw.notify("WikiEditor工具栏加载失败。",{type:"error"}),console.error(e)}"mediawiki"===o&&a.tags.html?(a.tagModes.html="htmlmixed",await ae("html")):"widget"!==o||CodeMirror.mimeModes.widget||CodeMirror.defineMIME("widget",{name:"htmlmixed",tags:{noinclude:[[null,null,"mediawiki"]]}});var n=e.height();O&&O.toTextArea();const s=i||"json"===H;(O=CodeMirror.fromTextArea(e[0],$.extend({inputStyle:"contenteditable",lineNumbers:!/Android\b/.test(navigator.userAgent),lineWrapping:!0,mode:o,mwConfig:a,json:s},Object.fromEntries(y.map(({option:e,addon:i=e,modes:t,complex:a=e=>!t||t.has(e)})=>{var n=Array.isArray(i)?i[0]:i;return[e,j.has(n)&&a(o,s)]})),"mediawiki"===o?{extraKeys:j.has("escape")&&G(CodeMirror)}:{indentUnit:j.has("indentWithSpace")?v:4,indentWithTabs:!j.has("indentWithSpace")}))).setSize(null,n),O.getWrapperElement().id="Wikiplus-CodeMirror",$.fn.textSelection&&e.textSelection("register",re);n=S(CodeMirror)?"Ctrl":"Cmd";if(j.has("wikiEditor")){const l=e.data("wikiEditorContext");O.addKeyMap({[n+"-F"](){$.wikiEditor.modules.dialogs.api.openDialog(l,"search-and-replace")}})}if(C(O,o),$("#Wikiplus-Quickedit-Jump").children("a").attr("href","#Wikiplus-CodeMirror"),!i){const d="object"==typeof window.Wikiplus?window.Wikiplus:{getSetting(e){var i=g.getObject("Wikiplus_Settings");return i&&i[e]}},c=d.getSetting("esc_to_exit_quickedit"),m=()=>{$("#Wikiplus-Quickedit-Submit").triggerHandler("click")},p=()=>{$("#Wikiplus-Quickedit-MinorEdit").click(),$("#Wikiplus-Quickedit-Submit").triggerHandler("click")};O.addKeyMap($.extend({[n+"-S"]:m,[`Shift-${n}-S`]:p},!0===c||"true"===c?{Esc(){$("#Wikiplus-Quickedit-Back").triggerHandler("click")}}:{}))}O.refresh(),mw.hook("wiki-codemirror").fire(O)},de=document["body"],ce=new MutationObserver(e=>{const i=$(e.flatMap(({addedNodes:e})=>[...e])).find("#Wikiplus-Quickedit, #Wikiplus-Setting-Input");0<i.length&&le(i,"Wikiplus-Setting-Input"===i.attr("id"))}),{get:me=e=>e.value,set:pe=(e,i)=>{e.value=i}}=(ce.observe(de,{childList:!0}),$(de).on("keydown.wphl",".ui-dialog",function(e){if("Escape"===e.key){const i=$(this).children(".ui-dialog-content").data("context");i&&i.$textarea&&"Wikiplus-Quickedit"===i.$textarea.attr("id")&&e.stopPropagation()}}),$.valHooks.textarea||{}),ge=e=>"Wikiplus-Quickedit"===e.id||"Wikiplus-Setting-Input"===e.id;$.valHooks.textarea={get(e){return ge(e)&&O?O.getValue():me(e)},set(e,i){ge(e)&&O?O.setValue(i):pe(e,i)}},await t;let T,A,we,he,I,ue,P;const ke=(e=[...j])=>{P.toggle(e.includes("indentWithSpace"))};const fe=$(mw.util.addPortletLink({minerva:"page-actions-overflow",citizen:"p-actions",moeskin:"ca-more-actions"}[r]||"p-cactions","#",w("portlet"),"wphl-settings")).click(async e=>{if(e.preventDefault(),T)A.setValue([...j]),I.setValue(v);else{await mw.loader.using(["oojs-ui-windows","oojs-ui.styles.icons-content"]),T=new OO.ui.MessageDialog({id:"Wikiplus-highlight-dialog"});const t=new OO.ui.WindowManager,a=(t.$element.appendTo(de),t.addWindows([T]),A=new OO.ui.CheckboxMultiselectInputWidget({options:[...y.map(({option:e,addon:i=e})=>{const t=Array.isArray(i)?i[0]:i;return{data:t,label:o("addon-"+t.toLowerCase())}}),...["wikiEditor","escape","contextmenu","lint","indentWithSpace","otherEditors"].map(e=>({data:e,label:o("addon-"+e.toLowerCase())}))],value:[...j]}).on("change",ke))["checkboxMultiselectWidget"];we=a.findItemFromData("search"),he=a.findItemFromData("wikiEditor"),I=new OO.ui.NumberInputWidget({min:0,value:v}),ue=new OO.ui.FieldLayout(A,{label:w("addon-label"),notices:[w("addon-notice")],align:"top"}),P=new OO.ui.FieldLayout(I,{label:w("addon-indent")}),ke(),Object.assign(mw.libs.wphl,{widget:A,indentWidget:I})}var i="object"==typeof window.Wikiplus||"object"==typeof window.Pages,i=(we.setDisabled(!i),he.setDisabled(!i||!mw.loader.getState("ext.wikiEditor")),await T.open({title:w("addon-title"),message:ue.$element.add(P.$element).add($("<p>",{html:w("feedback")})),actions:[{action:"reject",label:mw.msg("ooui-dialog-message-reject")},{action:"accept",label:mw.msg("ooui-dialog-message-accept"),flags:"progressive"}],size:"en"===W||"minerva"===r?"medium":"small"}).closing);if(ue.$element.detach(),P.$element.detach(),"object"==typeof i&&"accept"===i.action){i=A.getValue();j.clear();for(const n of i)j.add(n);v=Number(I.getValue()),g.setObject("Wikiplus-highlight-addons",i),g.setObject("Wikiplus-highlight-indent",v)}}),z=("minerva"===r&&fe.find(".mw-ui-icon").addClass("mw-ui-icon-minerva-settings"),"function"==typeof m&&m().find("#wphl-settings-notify").click(e=>{e.preventDefault(),$("#wphl-settings").triggerHandler("click")}),async i=>{if(j.has("otherEditors")){let e=i.getOption("mode");e="text/mediawiki"===e?"mediawiki":e;const a=ie(CodeMirror,!0),n=i.getOption("json"),{prototype:o,optionHandlers:s,helpers:{lint:r}}=CodeMirror;!o.annotateScrollbar&&"mediawiki"===e&&j.has("lint")&&a.push(x.annotateScrollbar),!window.wikiparse&&"mediawiki"===e&&j.has("lint")&&a.push(x.parser),!s.lint&&"mediawiki"===e&&j.has("lint")&&(mw.loader.load(`${p}/${h}/addon/lint/lint.min.css`,"text/css"),a.push(x.lint)),r&&r.mediawiki||"mediawiki"!==e||!j.has("lint")||a.push(x.lintWikitext),await ee(a);for(const{option:l,addon:d=l,modes:c,complex:m=e=>!c||c.has(e)}of y.filter(({only:e})=>!e)){var t=Array.isArray(d)?d[0]:d;void 0===i.getOption(l)&&j.has(t)&&i.setOption(l,m(e,n))}"mediawiki"===e&&j.has("escape")?i.addKeyMap(G(CodeMirror),!0):"mediawiki"!==e&&j.has("indentWithSpace")&&(i.setOption("indentUnit",v),i.setOption("indentWithTabs",!1)),C(i,e)}});mw.hook("InPageEdit.quickEdit.codemirror").add(({cm:e})=>z(e)),mw.hook("inspector").add(e=>z(e)),mw.hook("wiki-codemirror").add(e=>{e.getTextArea&&ge(e.getTextArea())||z(e)}),mw.loader.load(p+`/${a}/styles.min.css`,"text/css"),Object.assign(mw.libs.wphl,{version:i,options:y,addons:j,i18n:c,i18nLang:W,storage:g,$portlet:fe,CDN:p,PARSER_CDN:D,USING_LOCAL:k,MODE_LIST:l,ADDON_LIST:x,msg:w,htmlMsg:o,escapeHTML:q,handleContextMenu:C,setI18N:e,getAddonScript:ie,updateCachedConfig:ne,getMwConfig:se,renderEditor:le,handleOtherEditors:z,isPc:S})})();
//# sourceMappingURL=main.min.js.map